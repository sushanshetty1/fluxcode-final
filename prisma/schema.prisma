// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model - simplified for Supabase Auth
// Auth is handled by Supabase, we only store app-specific data
model User {
  id                  String               @id // Matches Supabase user.id
  name                String?
  email               String?              @unique
  image               String?
  linkedinUsername    String?
  leetcodeUsername    String?
  onboardingCompleted Boolean              @default(false)
  isAdmin             Boolean              @default(false)
  createdContests     Contest[]
  participations      ContestParticipant[]
  progress            UserProgress[]
  streaks             Streak[]
  achievements        UserAchievement[]
  notifications       Notification[]
  payments            Payment[]
  createdAt           DateTime             @default(now())
}

model Contest {
  id                   String               @id @default(cuid())
  name                 String
  description          String?
  creatorId            String
  creator              User                 @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  startDate            DateTime
  endDate              DateTime?
  isActive             Boolean              @default(true)
  password             String?
  easyProblemsPerDay   Int                  @default(2)
  mediumProblemsPerDay Int                  @default(1)
  hardDaysPerProblem   Int                  @default(2)
  penaltyAmount        Int                  @default(100)
  difficulty           String               @default("beginner")
  topics               Topic[]
  participants         ContestParticipant[]
  suggestions          DailySuggestion[]
  announcements        Announcement[]
  payments             Payment[]
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([creatorId])
  @@index([isActive])
}

model Topic {
  id                String         @id @default(cuid())
  contestId         String
  contest           Contest        @relation(fields: [contestId], references: [id], onDelete: Cascade)
  name              String
  description       String?
  subcategories     String[]
  questionsPerTopic Int            @default(10)
  allowedLanguages  String[]
  difficulty        String?
  orderIndex        Int
  isActive          Boolean        @default(false)
  hasStarted        Boolean        @default(false)
  topicStartedAt    DateTime?
  topicCompletedAt  DateTime?
  problems          Problem[]
  progress          UserProgress[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([contestId])
  @@index([isActive])
}

model Problem {
  id         String         @id @default(cuid())
  topicId    String
  topic      Topic          @relation(fields: [topicId], references: [id], onDelete: Cascade)
  leetcodeId String
  title      String
  difficulty String
  hyperlink  String
  tags       String[]
  orderIndex Int
  progress   UserProgress[]
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@unique([topicId, leetcodeId])
  @@index([topicId])
}

model ContestParticipant {
  id                    String    @id @default(cuid())
  contestId             String
  contest               Contest   @relation(fields: [contestId], references: [id], onDelete: Cascade)
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt              DateTime  @default(now())
  role                  String    @default("participant")
  isVisible             Boolean   @default(false)
  paymentStatus         String    @default("pending") // "pending", "paid", "failed"
  currentStreak         Int       @default(0)
  lastPaymentDate       DateTime?
  lastWeekendAttempt    DateTime?
  lastWeekendSuccess    Boolean   @default(false)

  @@unique([contestId, userId])
  @@index([contestId])
  @@index([userId])
  @@index([contestId, isVisible])
  @@index([contestId, paymentStatus])
}

model UserProgress {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  topicId     String
  isMissed    Boolean   @default(false)
  topic       Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  problemId   String
  problem     Problem   @relation(fields: [problemId], references: [id], onDelete: Cascade)
  completed   Boolean   @default(false)
  completedAt DateTime?
  verifiedAt  DateTime?
  solvingTime Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, problemId])
  @@index([userId])
  @@index([topicId])
  @@index([problemId])
  @@index([userId, completed])
  @@index([userId, topicId, completed])
  @@index([completedAt])
}

model DailySuggestion {
  id            String   @id @default(cuid())
  contestId     String
  contest       Contest  @relation(fields: [contestId], references: [id], onDelete: Cascade)
  date          DateTime @default(now())
  topicName     String
  subcategories String[]
  difficulty    String
  reasoning     String?
  isApplied     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([contestId])
  @@index([date])
}

model Streak {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastActiveAt  DateTime @default(now())
  freezesLeft   Int      @default(2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId])
  @@index([userId])
}

model Badge {
  id           String            @id @default(cuid())
  name         String            @unique
  description  String
  icon         String?
  criteria     String
  createdAt    DateTime          @default(now())
  achievements UserAchievement[]
}

model UserAchievement {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId  String
  badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt DateTime @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

model Announcement {
  id        String   @id @default(cuid())
  contestId String
  contest   Contest  @relation(fields: [contestId], references: [id], onDelete: Cascade)
  title     String
  content   String
  priority  String   @default("normal")
  createdAt DateTime @default(now())

  @@index([contestId])
}

model Payment {
  id                  String   @id @default(cuid())
  contestId           String
  contest             Contest  @relation(fields: [contestId], references: [id], onDelete: Cascade)
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  razorpayOrderId     String?
  razorpayPaymentId   String?
  razorpaySignature   String?
  amount              Int
  currency            String   @default("INR")
  status              String   @default("pending")
  isRefunded          Boolean  @default(false)
  weekNumber          Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([contestId])
  @@index([userId])
  @@index([status])
}
